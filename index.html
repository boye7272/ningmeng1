<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>柠檬AI图片图案处理工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#F59E0B', // 柠檬黄作为主色调
                        secondary: '#10B981',
                        neutral: '#64748B',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .transition-custom {
                transition: all 0.3s ease;
            }
            .shadow-custom {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }
            .btn-disabled {
                opacity: 0.6;
                cursor: not-allowed;
                background-color: #9CA3AF !important;
            }
            .instruction-active {
                border-color: #F59E0B; /* 柠檬黄黄活跃状态 */
                background-color: #FFFBEB; /* 浅黄背景 */
            }
            .option-active {
                background-color: #F59E0B;
                color: white;
                border-color: #F59E0B;
            }
            .image-zoom-container {
                z-index: 100;
                opacity: 0;
                visibility: hidden;
                transition: opacity 0.3s ease, visibility 0.3s ease;
            }
            .image-zoom-container.active {
                opacity: 1;
                visibility: visible;
            }
            .zoom-image {
                max-height: 90vh;
                max-width: 95vw;
                transition: transform 0.3s ease;
            }
            .painting-status {
                animation: pulse 1.5s infinite;
            }
            @keyframes pulse {
                0% { opacity: 1; }
                50% { opacity: 0.6; }
                100% { opacity: 1; }
            }
            .painting-steps {
                animation: slide 20s linear infinite;
            }
            @keyframes slide {
                0% { transform: translateY(0); }
                100% { transform: translateY(-50%); }
            }
            .maintenance-badge {
                position: absolute;
                top: -5px;
                right: -5px;
                background-color: #EF4444;
                color: white;
                font-size: 10px;
                font-weight: bold;
                padding: 2px 6px;
                border-radius: 10px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            }
            /* 弹窗样式 */
            .modal {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
                opacity: 0;
                visibility: hidden;
                transition: opacity 0.3s ease, visibility 0.3s ease;
            }
            .modal.active {
                opacity: 1;
                visibility: visible;
            }
            .modal-content {
                background-color: white;
                border-radius: 10px;
                padding: 2rem;
                max-width: 500px;
                width: 90%;
                text-align: center;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            }
            /* 格式转换提示 */
            .format-conversion-notice {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background-color: rgba(0, 0, 0, 0.7);
                color: white;
                padding: 0.5rem 1rem;
                border-radius: 4px;
                font-size: 0.875rem;
                z-index: 10;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen-screen font-sans">
    <!-- 顶部导航 -->
    <header class="bg-white shadow shadow-sm sticky top-0 z-10">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa fa-lemon-o text-primary text-2xl"></i> <!-- 柠檬图标 -->
                <h1 class="text-xl font-bold text-gray-800">柠檬AI图片图案处理工具</h1>
            </div>
            <div class="text-sm text-gray-500 hidden sm:block">
                基于AI的图片图案提取
            </div>
        </div>
    </header>

    <!-- 配置成功提示 -->
    <div id="config-toast" class="fixed bottom-4 right-4 bg-green-500 text-white px-4 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center z-50">
        <i class="fa fa-check-circle mr-2"></i>
        <span id="config-message">密码已设置</span>
    </div>

    <!-- 弹窗：次数用完 -->
    <div id="usage-exhausted-modal" class="modal">
        <div class="modal-content">
            <div class="text-primary text-5xl mb-4">
                <i class="fa fa-exclamation-circle"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">您的使用次数已用完</h3>
            <p class="text-gray-600 mb-6">请购买次数后再继续使用本服务</p>
            <div class="flex justify-center">
                <button class="modal-close bg-primary hover:bg-primary/90 text-white px-6 py-2 rounded-lg font-medium transition-custom">
                    确定
                </button>
            </div>
        </div>
    </div>

    <!-- 弹窗：更换卡密 -->
    <div id="change-token-modal" class="modal">
        <div class="modal-content">
            <div class="text-primary text-5xl mb-4">
                <i class="fa fa-exclamation-circle"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">卡密类型不匹配</h3>
            <p class="text-gray-600 mb-6">请您联系boye拿“通用处理”专用卡密</p>
            <div class="flex justify-center">
                <button class="modal-close bg-primary hover:bg-primary/90 text-white px-6 py-2 rounded-lg font-medium transition-custom">
                    确定
                </button>
            </div>
        </div>
    </div>

    <!-- 弹窗：图片过大 -->
    <div id="image-too-large-modal" class="modal">
        <div class="modal-content">
            <div class="text-primary text-5xl mb-4">
                <i class="fa fa-exclamation-circle"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">图片文件过大</h3>
            <p class="text-gray-600 mb-6">请上传10MB以下的图片</p>
            <div class="flex justify-center">
                <button class="modal-close bg-primary hover:bg-primary/90 text-white px-6 py-2 rounded-lg font-medium transition-custom">
                    确定
                </button>
            </div>
        </div>
    </div>

    <!-- 图片悬浮查看器 -->
    <div id="image-zoom" class="image-zoom-container fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center">
        <button id="close-zoom" class="absolute top-4 right-4 text-white text-3xl hover:text-gray-300 transition-custom">
            <i class="fa fa-times"></i>
        </button>
        <img id="zoom-image" class="zoom-image rounded-lg" src="" alt="放大查看的图片">
    </div>

    <!-- 主要内容：双栏布局 -->
    <main class="container mx-auto px-4 py-8 max-w-7xl">
        <div class="flex flex-col lg:flex-row gap-8">
            <!-- 左侧：主要功能区 -->
            <div class="lg:w-2/3 max-w-3xl">
                <!-- 说明文字 -->
                <div class="text-center mb-8">
                    <h2 class="text-[clamp(1.5rem,3vw,2rem)] font-semibold text-gray-800 mb-3">提取图片中的图案</h2>
                    <p class="text-gray-600 max-w-2xl mx-auto">上传图片，选择处理方式，我们将使用AI技术帮您提取图案，适合数码印花等用途。</p>
                </div>

                <!-- 密码输入区域 -->
                <div class="bg-white rounded-xl shadow-custom p-6 mb-8">
                    <div class="flex flex-col md:flex-row gap-4 items-start">
                        <div class="flex-shrink-0">
                            <i class="fa fa-lock text-primary text-2xl mt-0.5"></i>
                        </div>
                        <div class="flex-1 w-full flex flex-col md:flex-row gap-4">
                            <!-- 密码输入框部分 -->
                            <div class="w-full md:w-2/3">
                                <div class="relative w-full">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i class="fa fa-shield text-gray-400"></i>
                                    </div>
                                    <input type="password" id="access-password" name="access-password" required
                                        class="block w-full pl-10 pr-10 py-2.5 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary transition-custom"
                                        placeholder="请输入你的密码">
                                    <button type="button" id="toggle-password-visibility" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600">
                                        <i class="fa fa-eye-slash"></i>
                                    </button>
                                </div>
                                <p class="mt-2 text-sm text-gray-500">输入密码后即可使用图案提取功能</p>
                            </div>
                            
                            <!-- 新增：二维码和购买提示 -->
                            <div class="w-full md:w-1/3 flex flex-col items-center justify-center p-2 border border-gray-100 rounded-lg bg-gray-50">
                                <!-- 二维码图片 -->
                                <img src="https://imgchr.com/content/images/users/pGzZQ0/av_1760166729.jpg" alt="购买卡密二维码" class="w-24 h-24 object-contain mb-2">
                                <!-- 提示语 -->
                                <p class="text-xs text-gray-700 text-center">扫码购买卡密<br>生图消耗0.3￥一张</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 处理指令选择 -->
                <div class="bg-white rounded-xl shadow-custom p-6 mb-8">
                    <h3 class="text-lg font-medium text-gray-800 mb-4 flex items-center">
                        <i class="fa fa-list-ul text-primary mr-2"></i>选择处理方式
                    </h3>
                    <!-- 修改：将处理方式改为一排显示 -->
                    <div class="flex flex-wrap gap-4" id="instructions-container">
                        <!-- 指令选项1 - 循环图 -->
                        <div class="instruction-option border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-primary transition-custom relative flex-1 min-w-[200px]" data-instruction="repeat" data-model="nano-banana-vip">
                            <h4 class="font-medium text-gray-800 mb-2">循环图</h4>
                            <p class="text-sm text-gray-600">将图案处理为四方连续的循环图案，适合大面积印花使用，图案可无缝拼接。</p>
                        </div>
                        
                        <!-- 指令选项2 - 定位花 -->
                        <div class="instruction-option border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-primary transition-custom relative flex-1 min-w-[200px]" data-instruction="position" data-model="nano-banana-vip">
                            <h4 class="font-medium text-gray-800 mb-2">定位花</h4>
                            <p class="text-sm text-gray-600">精确定位图案主体，优化细节展示，适合需要突出主体图案的定位印花。</p>
                        </div>

                        <!-- 新增指令选项3 - 矢量风格图案 -->
                        <div class="instruction-option border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-primary transition-custom flex-1 min-w-[200px]" data-instruction="vector" data-model="gpt-image-1">
                            <h4 class="font-medium text-gray-800 mb-2">矢量风格图案</h4>
                            <p class="text-sm text-gray-600">比如球服、徽章、logo等图案的提取，可以选择矢量风格输出。按截图比例选择输出比例。出图时间会稍慢一些、图案更清晰！大概3分钟出一张图。不适合花卉等密集花型提取</p>
                            
                            <!-- 输出风格和比例选项 -->
                            <div id="vector-options" class="mt-4">
                                <div class="mb-3">
                                    <p class="text-sm text-gray-600 mb-1">输出风格：</p>
                                    <div class="flex gap-2">
                                        <button type="button" id="style-vector" class="style-option px-3 py-1.5 border border-gray-300 rounded-md text-sm hover:border-primary transition-custom">
                                            矢量风格
                                        </button>
                                        <button type="button" id="style-seamless" class="style-option px-3 py-1.5 border border-gray-300 rounded-md text-sm hover:border-primary transition-custom">
                                            无缝循环
                                        </button>
                                    </div>
                                </div>
                                
                                <div>
                                    <p class="text-sm text-gray-600 mb-1">输出比例：</p>
                                    <div class="flex gap-2 flex-wrap">
                                        <button type="button" id="ratio-1-1" class="ratio-option px-3 py-1.5 border border-gray-300 rounded-md text-sm hover:border-primary transition-custom">
                                            1:1
                                        </button>
                                        <button type="button" id="ratio-2-3" class="ratio-option px-3 py-1.5 border border-gray-300 rounded-md text-sm hover:border-primary transition-custom">
                                            2:3
                                        </button>
                                        <button type="button" id="ratio-3-2" class="ratio-option px-3 py-1.5 border border-gray-300 rounded-md text-sm hover:border-primary transition-custom">
                                            3:2
                                        </button>
                                    </div>
                                    <p id="ratio-required" class="mt-1 text-xs text-red-500 hidden">请选择输出比例</p>
                                </div>
                            </div>
                        </div>

                        <!-- 新增指令选项4 - 进一步处理-->
                        <div class="instruction-option border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-primary transition-custom flex-1 min-w-[200px]" data-instruction="advanced" data-model="nano-banana-vip">
                            <h4 class="font-medium text-gray-800 mb-2">进一步处理</h4>
                            <p class="text-sm text-gray-600">换背景、去水印、去绣花、换风格(3D,刺绣,水彩等）、花型图案换色、服装换色换花型、模特换装试衣等都可以在这个处理方式实现</p>
                            <!-- 自定义指令输入框 -->
                            <div id="advanced-options" class="mt-4">
                                <p class="text-sm text-gray-600 mb-1">请输入处理指令：</p>
                                <textarea id="custom-instruction" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-primary focus:border-primary transition-custom" placeholder="例如：例如:提取花卉图案，将背景换成白色/提取花卉图案，去除绣花图案/根据图片1中的图案颜色给图片2中的图案上色。"></textarea>
                                <p id="instruction-required" class="mt-1 text-xs text-red-500 hidden">请输入处理指令</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 图片上传区域 -->
                <div class="bg-white rounded-xl shadow-custom p-6 mb-8">
                    <div id="single-image-container" class="flex flex-col md:flex-row gap-6">
                        <!-- 原始图片区域 -->
                        <div class="flex-1">
                            <h3 class="text-lg font-medium text-gray-800 mb-3 flex items-center">
                                <i class="fa fa-upload text-primary mr-2"></i>上传图片
                            </h3>
                            <div id="upload-area" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-primary transition-custom">
                                <input type="file" id="image-upload" accept="image/*" class="hidden">
                                <i class="fa fa-image text-5xl text-gray-400 mb-3"></i>
                                <p class="text-gray-600 mb-2">点击或拖拽图片到此处上传</p>
                                <p class="text-sm text-gray-500">支持 JPG、PNG 等格式</p>
                            </div>
                            <div id="image-preview-container" class="hidden mt-4">
                                <img id="image-preview" class="max-w-full max-h-64 mx-auto rounded-lg shadow-sm cursor-zoom-in" src="" alt="预览图" title="点击放大查看">
                                <div class="mt-2 text-right">
                                    <button id="change-image-btn" class="text-primary text-sm hover:underline">
                                        <i class="fa fa-refresh mr-1"></i> 更换图片
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- 处理结果区域 -->
                        <div class="flex-1">
                            <h3 class="text-lg font-medium text-gray-800 mb-3 flex items-center">
                                <i class="fa fa-magic text-secondary mr-2"></i>处理结果
                            </h3>
                            <div id="result-area" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center transition-custom">
                                <i class="fa fa-picture-o text-5xl text-gray-400 mb-3"></i>
                                <p class="text-gray-600">处理后的图案将显示在这里</p>
                            </div>
                            <div id="result-image-container" class="hidden mt-4 relative">
                                <div id="format-conversion-notice" class="format-conversion-notice hidden">
                                    <i class="fa fa-spinner fa-spin mr-1"></i> 转换为PNG格式中...
                                </div>
                                <img id="result-image" class="max-w-full max-h-64 mx-auto rounded-lg shadow-sm cursor-zoom-in" src="" alt="处理结果图" title="点击放大查看">
                                <div class="mt-3 text-center">
                                    <button id="download-btn" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-md text-sm flex items-center justify-center mx-auto transition-custom">
                                        <i class="fa fa-download mr-1"></i> 下载图片
                                    </button>
                                    <div class="mt-2 flex items-center justify-center">
                                        <button id="reprocess-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-md text-sm flex items-center transition-custom">
                                            <i class="fa fa-refresh mr-1"></i> 
                                            <span id="reprocess-text">重新处理</span>
                                            <span id="reprocess-timer" class="ml-2 hidden">20s</span>
                                        </button>
                                        <span id="process-count" class="ml-3 text-sm text-gray-500">
                                            已处理: <span class="font-medium text-gray-700">0</span> 次
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 多图上传区域 - 初始隐藏 -->
                    <div id="multi-image-container" class="hidden">
                        <div class="flex flex-col md:flex-row gap-6">
                            <!-- 第一张图片上传区域 -->
                            <div class="flex-1">
                                <h3 class="text-lg font-medium text-gray-800 mb-3 flex items-center">
                                    <i class="fa fa-upload text-primary mr-2"></i>上传图片1
                                </h3>
                                <div id="upload-area-1" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-primary transition-custom">
                                    <input type="file" id="image-upload-1" accept="image/*" class="hidden">
                                    <i class="fa fa-image text-5xl text-gray-400 mb-3"></i>
                                    <p class="text-gray-600 mb-2">点击或拖拽图片到此处上传</p>
                                    <p class="text-sm text-gray-500">支持 JPG、PNG 等格式</p>
                                </div>
                                <div id="image-preview-container-1" class="hidden mt-4">
                                    <img id="image-preview-1" class="max-w-full max-h-64 mx-auto rounded-lg shadow-sm cursor-zoom-in" src="" alt="预览图1" title="点击放大查看">
                                    <div class="mt-2 text-right">
                                        <button id="change-image-btn-1" class="text-primary text-sm hover:underline">
                                            <i class="fa fa-refresh mr-1"></i> 更换图片
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- 第二张图片上传区域 -->
                            <div class="flex-1">
                                <h3 class="text-lg font-medium text-gray-800 mb-3 flex items-center">
                                    <i class="fa fa-upload text-primary mr-2"></i>上传图片2（可选）
                                </h3>
                                <div id="upload-area-2" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-primary transition-custom">
                                    <input type="file" id="image-upload-2" accept="image/*" class="hidden">
                                    <i class="fa fa-image text-5xl text-gray-400 mb-3"></i>
                                    <p class="text-gray-600 mb-2">点击或拖拽图片到此处上传（可选）</p>
                                    <p class="text-sm text-gray-500">支持 JPG、PNG 等格式</p>
                                </div>
                                <div id="image-preview-container-2" class="hidden mt-4">
                                    <img id="image-preview-2" class="max-w-full max-h-64 mx-auto rounded-lg shadow-sm cursor-zoom-in" src="" alt="预览图2" title="点击放大查看">
                                    <div class="mt-2 text-right">
                                        <button id="change-image-btn-2" class="text-primary text-sm hover:underline">
                                            <i class="fa fa-refresh mr-1"></i> 更换图片
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 处理结果区域 -->
                        <div class="mt-6">
                            <h3 class="text-lg font-medium text-gray-800 mb-3 flex items-center">
                                <i class="fa fa-magic text-secondary mr-2"></i>处理结果
                            </h3>
                            <div id="multi-result-area" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center transition-custom">
                                <i class="fa fa-picture-o text-5xl text-gray-400 mb-3"></i>
                                <p class="text-gray-600">处理后的图案将显示在这里</p>
                            </div>
                            <div id="multi-result-image-container" class="hidden mt-4 relative">
                                <div id="multi-format-conversion-notice" class="format-conversion-notice hidden">
                                    <i class="fa fa-spinner fa-spin mr-1"></i> 转换为PNG格式中...
                                </div>
                                <img id="multi-result-image" class="max-w-full max-h-64 mx-auto rounded-lg shadow-sm cursor-zoom-in" src="" alt="处理结果图" title="点击放大查看">
                                <div class="mt-3 text-center">
                                    <button id="multi-download-btn" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-md text-sm flex items-center justify-center mx-auto transition-custom">
                                        <i class="fa fa-download mr-1"></i> 下载图片
                                    </button>
                                    <div class="mt-2 flex items-center justify-center">
                                        <button id="multi-reprocess-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-md text-sm flex items-center transition-custom">
                                            <i class="fa fa-refresh mr-1"></i> 
                                            <span id="multi-reprocess-text">重新处理</span>
                                            <span id="multi-reprocess-timer" class="ml-2 hidden">20s</span>
                                        </button>
                                        <span id="multi-process-count" class="ml-3 text-sm text-gray-500">
                                            已处理: <span class="font-medium text-gray-700">0</span> 次
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 处理按钮 -->
                    <div class="mt-6 text-center">
                        <button id="process-btn" class="bg-secondary hover:bg-secondary/90 text-white px-6 py-3 rounded-lg font-medium shadow-sm disabled:opacity-50 disabled:cursor-not-allowed transition-custom flex items-center justify-center mx-auto">
                            <i class="fa fa-cog mr-2"></i> 开始提取图案
                        </button>
                    </div>
                </div>

                <!-- 错误提示 -->
                <div id="error-container" class="hidden bg-red-50 border border-red-200 rounded-xl p-6 mb-8">
                    <div class="flex">
                        <i class="fa fa-exclamation-circle text-red-500 mt-0.5 mr-3 text-xl"></i>
                        <div>
                            <h3 class="text-lg font-medium text-red-800 mb-1">处理出错</h3>
                            <p id="error-message" class="text-red-700 text-sm"></p>
                            <div class="mt-3">
                                <button id="retry-btn" class="text-red-600 hover:text-red-800 text-sm font-medium">
                                    <i class="fa fa-refresh mr-1"></i> 重试
                                </button>
                                <button id="continue-waiting-btn" class="text-primary hover:text-primary/80 text-sm font-medium ml-3">
                                    <i class="fa fa-clock-o mr-1"></i> 继续等待
                                </button>
                                <button id="edit-password-btn" class="text-primary hover:text-primary/80 text-sm font-medium ml-3">
                                    <i class="fa fa-lock mr-1"></i> 重新输入密码
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右侧：历史记录和处理状态区域 -->
            <div class="lg:w-1/3">
                <!-- 历史记录区域 -->
                <div class="bg-white rounded-xl shadow-custom p-6 mb-6">
                    <h3 class="text-lg font-medium text-gray-800 mb-3 flex items-center">
                        <i class="fa fa-history text-neutral mr-2"></i>历史记录
                    </h3>
                    <div id="history-container" class="grid grid-cols-2 sm:grid-cols-3 gap-3 max-h-[300px] overflow-y-auto pr-1">
                        <div class="text-center text-gray-500 text-sm py-6 border border-dashed border-gray-200 rounded-lg col-span-full">
                            暂无历史记录
                        </div>
                    </div>
                </div>
                
                <!-- 处理状态 -->
                <div id="status-container" class="hidden bg-white rounded-xl shadow-custom p-6 sticky top-[340px]">
                    <h3 class="text-lg font-medium text-gray-800 mb-3">处理状态</h3>
                    <div class="flex items-center">
                        <div id="loading-indicator" class="animate-spin rounded-full h-5 w-5 border-t-2 border-b-2 border-primary mr-3"></div>
                        <p id="status-message" class="text-gray-600">正在处理图片，请稍候...</p>
                    </div>
                    <div id="painting-progress" class="hidden mt-4">
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div id="painting-bar" class="bg-secondary h-2.5 rounded-full transition-all duration-1000" style="width: 0%"></div>
                        </div>
                        <div class="mt-2 relative h-6 overflow-hidden">
                            <div class="painting-steps whitespace-nowrap">
                                <p class="text-right text-sm text-gray-500 painting-status">AI正在绘制图案... 正在处理细节... 优化图案边缘... 调整色彩平衡... AI正在绘制图案... 正在处理细节... 优化图案边缘... 调整色彩平衡...</p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div id="progress-bar" class="bg-primary h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                        <p id="progress-text" class="text-right text-sm text-gray-500 mt-1">0%</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="bg-white border-t border-gray-200 py-6 mt-12">
        <div class="container mx-auto px-4 text-center text-gray-500 text-sm">
            <p>柠檬图案提取工具 &copy; 2025</p>
        </div>
    </footer>

    <script>
        // DOM元素 - 密码输入相关
        const accessPasswordInput = document.getElementById('access-password');
        const togglePasswordVisibility = document.getElementById('toggle-password-visibility');
        const configToast = document.getElementById('config-toast');
        const configMessage = document.getElementById('config-message');
        const editPasswordBtn = document.getElementById('edit-password-btn');
        const continueWaitingBtn = document.getElementById('continue-waiting-btn');
        
        // 弹窗元素
        const modals = {
            usageExhausted: document.getElementById('usage-exhausted-modal'),
            changeToken: document.getElementById('change-token-modal'),
            imageTooLarge: document.getElementById('image-too-large-modal')
        };
        const modalCloseButtons = document.querySelectorAll('.modal-close');

        // 指令选择相关元素
        const instructionOptions = document.querySelectorAll('.instruction-option');
        const vectorOptions = document.getElementById('vector-options');
        const advancedOptions = document.getElementById('advanced-options');
        const customInstructionInput = document.getElementById('custom-instruction');
        const instructionRequired = document.getElementById('instruction-required');
        const styleOptions = document.querySelectorAll('.style-option');
        const ratioOptions = document.querySelectorAll('.ratio-option');
        const ratioRequired = document.getElementById('ratio-required');
        let selectedInstruction = 'repeat';
        let selectedModel = 'nano-banana-vip';
        let selectedStyle = [];
        let selectedRatio = null;
        let customInstruction = '';

        // 图片上传区域相关元素
        const singleImageContainer = document.getElementById('single-image-container');
        const multiImageContainer = document.getElementById('multi-image-container');
        
        // 单图上传元素
        const uploadArea = document.getElementById('upload-area');
        const imageUpload = document.getElementById('image-upload');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const changeImageBtn = document.getElementById('change-image-btn');
        
        // 多图上传元素
        const uploadArea1 = document.getElementById('upload-area-1');
        const imageUpload1 = document.getElementById('image-upload-1');
        const imagePreviewContainer1 = document.getElementById('image-preview-container-1');
        const imagePreview1 = document.getElementById('image-preview-1');
        const changeImageBtn1 = document.getElementById('change-image-btn-1');
        
        const uploadArea2 = document.getElementById('upload-area-2');
        const imageUpload2 = document.getElementById('image-upload-2');
        const imagePreviewContainer2 = document.getElementById('image-preview-container-2');
        const imagePreview2 = document.getElementById('image-preview-2');
        const changeImageBtn2 = document.getElementById('change-image-btn-2');
        
        // 结果区域元素
        const resultArea = document.getElementById('result-area');
        const resultImageContainer = document.getElementById('result-image-container');
        const resultImage = document.getElementById('result-image');
        const downloadBtn = document.getElementById('download-btn');
        
        const multiResultArea = document.getElementById('multi-result-area');
        const multiResultImageContainer = document.getElementById('multi-result-image-container');
        const multiResultImage = document.getElementById('multi-result-image');
        const multiDownloadBtn = document.getElementById('multi-download-btn');

        // 处理按钮相关
        const processBtn = document.getElementById('process-btn');
        const reprocessBtn = document.getElementById('reprocess-btn');
        const reprocessText = document.getElementById('reprocess-text');
        const reprocessTimer = document.getElementById('reprocess-timer');
        
        const multiReprocessBtn = document.getElementById('multi-reprocess-btn');
        const multiReprocessText = document.getElementById('multi-reprocess-text');
        const multiReprocessTimer = document.getElementById('multi-reprocess-timer');

        // 状态相关元素
        const statusContainer = document.getElementById('status-container');
        const statusMessage = document.getElementById('status-message');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const paintingProgress = document.getElementById('painting-progress');
        const paintingBar = document.getElementById('painting-bar');

        // 错误处理相关
        const errorContainer = document.getElementById('error-container');
        const errorMessage = document.getElementById('error-message');
        const retryBtn = document.getElementById('retry-btn');

        // 历史记录相关
        const historyContainer = document.getElementById('history-container');
        const processCountElement = document.querySelector('#process-count .font-medium');
        const multiProcessCountElement = document.querySelector('#multi-process-count .font-medium');
        const formatConversionNotice = document.getElementById('format-conversion-notice');
        const multiFormatConversionNotice = document.getElementById('multi-format-conversion-notice');
        
        // 图片放大查看相关元素
        const imageZoom = document.getElementById('image-zoom');
        const zoomImage = document.getElementById('zoom-image');
        const closeZoom = document.getElementById('close-zoom');
        
        // 处理次数计数器
        let processCount = 0;
        // 重新处理冷却时间（秒）
        const REPROCESS_COOLDOWN = 20;
        // 冷却计时器ID
        let cooldownTimer = null;
        let multiCooldownTimer = null;
        // 绘画状态计时器
        let paintingTimer = null;
        // 当前的图片处理会话ID
        let currentSessionId = null;
        // 最大等待尝试次数
        const MAX_WAIT_ATTEMPTS = 5;
        // 当前等待尝试次数
        let currentWaitAttempt = 0;

        // 配置参数
        let ACCESS_PASSWORD = "";
        const API_ENDPOINT = "https://api.tu-zi.com/v1/chat/completions";
        const API_TIMEOUT = 1200000; // 20分钟超时，给AI足够的绘画时间
        const PAINTING_PROGRESS_INTERVAL = 5000;
        const CHECK_RESULT_INTERVAL = 30000;
        const CORS_PROXY = "https://cors-anywhere.herokuapp.com/";

        // 四种处理指令的详细描述
        const instructionDetails = {
            repeat: `指令：把衣服的印花图案平铺开
要求：
1. 保持图案大小、位置、排布不变
2. 校正图案，还原出图案平整的样子
3. 把不完整的图案绘制完整
4. 不要改变图案的颜色和风格
5. 去掉褶皱，重绘平整
6. 做成印刷用的四方无缝循环图案

输出格式：
仅返回一个直接可访问的图片URL或Base64编码，格式为JPG或PNG，不添加任何其他文字或说明。`,
            
            position: `指令：把衣服的印花图案平铺开
要求：
1. 保持图案大小、位置、排布不变
2. 校正图案，还原出图案平整的样子
3. 把不完整的图案绘制完整
4. 不要改变图案的颜色和风格
5. 去掉褶皱，重绘平整
6. 优化图案主体定位，突出主体展示，适合定位印花使用

输出格式：
仅返回一个直接可访问的图片URL或Base64编码，格式为JPG或PNG，不添加任何其他文字或说明。`,

            vector: `指令：请处理这张图片，将图案做成壁纸。
要求：
1. 去掉褶皱
2. 还原出图案没被折叠进去的样子
3. 不要改变图案排布
4. 不要改变图案位置
5. 图案缺失部分向外补充完整
6. 不要改变图案的颜色
{styleOptions}
{ratioOption}

输出格式：
仅返回一个直接可访问的图片URL，格式为JPG或PNG，不添加任何其他文字或说明。`,

            advanced: `{customInstruction}

输出格式：
仅返回一个直接可访问的图片URL或Base64编码，格式为JPG或PNG，不添加任何其他文字或说明。`
        };

        // 初始状态：处理按钮不可用
        processBtn.disabled = true;

        // 弹窗关闭按钮事件
        modalCloseButtons.forEach(button => {
            button.addEventListener('click', () => {
                Object.values(modals).forEach(modal => {
                    modal.classList.remove('active');
                });
                
                if (button.closest('#usage-exhausted-modal') || button.closest('#change-token-modal')) {
                    accessPasswordInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    setTimeout(() => {
                        accessPasswordInput.focus();
                    }, 500);
                }
            });
        });

        // 点击弹窗背景关闭
        Object.values(modals).forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                    
                    if (modal === modals.usageExhausted || modal === modals.changeToken) {
                        accessPasswordInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        setTimeout(() => {
                            accessPasswordInput.focus();
                        }, 500);
                    }
                }
            });
        });

        // 指令选择逻辑
        instructionOptions.forEach(option => {
            option.addEventListener('click', () => {
                // 移除所有选项的活跃状态
                instructionOptions.forEach(opt => opt.classList.remove('instruction-active'));
                // 设置当前选项为活跃状态
                option.classList.add('instruction-active');
                // 记录选中的指令和模型
                selectedInstruction = option.getAttribute('data-instruction');
                selectedModel = option.getAttribute('data-model');
                
                // 根据选择的指令切换图片上传区域
                if (selectedInstruction === 'advanced') {
                    // 进一步处理显示多图上传
                    singleImageContainer.classList.add('hidden');
                    multiImageContainer.classList.remove('hidden');
                } else {
                    // 其他处理显示单图上传
                    singleImageContainer.classList.remove('hidden');
                    multiImageContainer.classList.add('hidden');
                }
                
                // 重置相关选择
                if (selectedInstruction === 'repeat' || selectedInstruction === 'position') {
                    styleOptions.forEach(opt => opt.classList.remove('option-active'));
                    selectedStyle = [];
                    
                    ratioOptions.forEach(opt => opt.classList.remove('option-active'));
                    selectedRatio = null;
                    
                    customInstructionInput.value = '';
                    customInstruction = '';
                    
                    ratioRequired.classList.add('hidden');
                    instructionRequired.classList.add('hidden');
                } else if (selectedInstruction === 'advanced') {
                    styleOptions.forEach(opt => opt.classList.remove('option-active'));
                    selectedStyle = [];
                    
                    ratioOptions.forEach(opt => opt.classList.remove('option-active'));
                    selectedRatio = null;
                    
                    ratioRequired.classList.add('hidden');
                    
                    setTimeout(() => {
                        customInstructionInput.focus();
                    }, 300);
                } else {
                    customInstructionInput.value = '';
                    customInstruction = '';
                    
                    instructionRequired.classList.add('hidden');
                }
                
                // 验证按钮状态
                validateProcessButton();
            });
        });

        // 输出风格选择逻辑
        styleOptions.forEach(option => {
            option.addEventListener('click', () => {
                const isActive = option.classList.contains('option-active');
                const styleId = option.id;
                
                if (!isActive) {
                    option.classList.add('option-active');
                    if (styleId === 'style-vector') {
                        selectedStyle.push('vector');
                    } else if (styleId === 'style-seamless') {
                        selectedStyle.push('seamless');
                    }
                } else {
                    option.classList.remove('option-active');
                    if (styleId === 'style-vector') {
                        selectedStyle = selectedStyle.filter(s => s !== 'vector');
                    } else if (styleId === 'style-seamless') {
                        selectedStyle = selectedStyle.filter(s => s !== 'seamless');
                    }
                }
            });
        });

        // 输出比例选择逻辑
        ratioOptions.forEach(option => {
            option.addEventListener('click', () => {
                const isActive = option.classList.contains('option-active');
                
                ratioOptions.forEach(opt => opt.classList.remove('option-active'));
                
                if (!isActive) {
                    option.classList.add('option-active');
                    selectedRatio = option.id.replace('ratio-', '').replace('-', ':');
                } else {
                    selectedRatio = null;
                }
                
                ratioRequired.classList.add('hidden');
                validateProcessButton();
            });
        });

        // 自定义指令输入处理
        customInstructionInput.addEventListener('input', () => {
            customInstruction = customInstructionInput.value.trim();
            instructionRequired.classList.add('hidden');
            validateProcessButton();
        });

        // 验证处理按钮状态 - 核心修改：支持单图或双图上传
        function validateProcessButton() {
            const hasPassword = !!ACCESS_PASSWORD;
            let hasImage = false;
            
            // 根据当前选中的指令检查图片上传状态
            if (selectedInstruction === 'advanced') {
                // 进一步处理支持1张或2张图片上传
                hasImage = imagePreviewContainer1.classList.contains('hidden') === false;
            } else {
                // 其他处理只需要一张图片
                hasImage = imagePreviewContainer.classList.contains('hidden') === false;
            }
            
            // 矢量风格需要选择比例
            const vectorStyleValid = selectedInstruction !== 'vector' || !!selectedRatio;
            
            // 进一步处理需要输入指令
            const advancedValid = selectedInstruction !== 'advanced' || (!!customInstruction && customInstruction.length >= 5);
            
            // 更新按钮状态
            processBtn.disabled = !(hasPassword && hasImage && vectorStyleValid && advancedValid);
        }

        // 密码输入实时处理
        accessPasswordInput.addEventListener('input', () => {
            const password = accessPasswordInput.value.trim();
            ACCESS_PASSWORD = password;
            
            validateProcessButton();
            
            if (password && password.length >= 3) {
                configMessage.textContent = '密码已设置';
                configToast.classList.remove('translate-y-20', 'opacity-0');
                
                setTimeout(() => {
                    configToast.classList.add('translate-y-20', 'opacity-0');
                }, 2000);
            }
        });

        // 切换密码可见性
        togglePasswordVisibility.addEventListener('click', () => {
            const type = accessPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            accessPasswordInput.setAttribute('type', type);
            togglePasswordVisibility.innerHTML = type === 'password' ? 
                '<i class="fa fa-eye-slash"></i>' : 
                '<i class="fa fa-eye"></i>';
        });

        // 重新输入密码按钮
        editPasswordBtn.addEventListener('click', () => {
            errorContainer.classList.add('hidden');
            accessPasswordInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
            setTimeout(() => {
                accessPasswordInput.focus();
            }, 500);
        });

        // 继续等待按钮事件
        continueWaitingBtn.addEventListener('click', () => {
            if (!currentSessionId) {
                errorContainer.classList.add('hidden');
                processImage();
                return;
            }
            
            errorContainer.classList.add('hidden');
            statusContainer.classList.remove('hidden');
            statusMessage.textContent = `继续等待结果 (${currentWaitAttempt + 1}/${MAX_WAIT_ATTEMPTS})`;
            paintingProgress.style.display = 'block';
            processBtn.disabled = true;
            reprocessBtn.disabled = true;
            multiReprocessBtn.disabled = true;
            
            currentWaitAttempt++;
            
            if (currentWaitAttempt >= MAX_WAIT_ATTEMPTS) {
                showError(`已等待较长时间仍未获取结果。\n\n建议：\n1. 检查图片是否清晰\n2. 尝试使用较小的图片\n3. 稍后再试`);
                currentWaitAttempt = 0;
                return;
            }
            
            setTimeout(() => {
                checkProcessingResult(currentSessionId);
            }, 1000);
        });

        // 重试按钮事件
        retryBtn.addEventListener('click', () => {
            currentWaitAttempt = 0;
            errorContainer.classList.add('hidden');
            processImage();
        });

        // 单图上传区域点击触发文件选择
        uploadArea.addEventListener('click', () => {
            imageUpload.click();
        });

        // 多图上传区域点击触发文件选择
        uploadArea1.addEventListener('click', () => {
            imageUpload1.click();
        });
        
        uploadArea2.addEventListener('click', () => {
            imageUpload2.click();
        });

        // 更换图片按钮
        changeImageBtn.addEventListener('click', () => {
            imageUpload.click();
            clearCooldown();
            currentWaitAttempt = 0;
        });
        
        changeImageBtn1.addEventListener('click', () => {
            imageUpload1.click();
            clearMultiCooldown();
            currentWaitAttempt = 0;
        });
        
        changeImageBtn2.addEventListener('click', () => {
            imageUpload2.click();
            clearMultiCooldown();
            currentWaitAttempt = 0;
        });

        // 重新处理按钮
        reprocessBtn.addEventListener('click', () => {
            if (reprocessBtn.classList.contains('btn-disabled')) {
                return;
            }
            
            if (selectedInstruction === 'vector' && !selectedRatio) {
                ratioRequired.classList.remove('hidden');
                document.getElementById('vector-options').scrollIntoView({ behavior: 'smooth', block: 'center' });
                return;
            }
            
            currentWaitAttempt = 0;
            processImage();
            startCooldown();
        });
        
        multiReprocessBtn.addEventListener('click', () => {
            if (multiReprocessBtn.classList.contains('btn-disabled')) {
                return;
            }
            
            if (selectedInstruction === 'advanced' && (!customInstruction || customInstruction.length < 5)) {
                instructionRequired.classList.remove('hidden');
                customInstructionInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                setTimeout(() => {
                    customInstructionInput.focus();
                }, 300);
                return;
            }
            
            currentWaitAttempt = 0;
            processImage();
            startMultiCooldown();
        });

        // 启动冷却计时器
        function startCooldown() {
            let secondsLeft = REPROCESS_COOLDOWN;
            
            reprocessBtn.disabled = true;
            reprocessBtn.classList.add('btn-disabled');
            
            reprocessText.textContent = '重新处理';
            reprocessTimer.textContent = `${secondsLeft}s`;
            reprocessTimer.classList.remove('hidden');
            
            if (cooldownTimer) {
                clearInterval(cooldownTimer);
            }
            
            cooldownTimer = setInterval(() => {
                secondsLeft--;
                reprocessTimer.textContent = `${secondsLeft}s`;
                
                if (secondsLeft <= 0) {
                    clearCooldown();
                }
            }, 1000);
        }
        
        function startMultiCooldown() {
            let secondsLeft = REPROCESS_COOLDOWN;
            
            multiReprocessBtn.disabled = true;
            multiReprocessBtn.classList.add('btn-disabled');
            
            multiReprocessText.textContent = '重新处理';
            multiReprocessTimer.textContent = `${secondsLeft}s`;
            multiReprocessTimer.classList.remove('hidden');
            
            if (multiCooldownTimer) {
                clearInterval(multiCooldownTimer);
            }
            
            multiCooldownTimer = setInterval(() => {
                secondsLeft--;
                multiReprocessTimer.textContent = `${secondsLeft}s`;
                
                if (secondsLeft <= 0) {
                    clearMultiCooldown();
                }
            }, 1000);
        }

        // 清除冷却状态
        function clearCooldown() {
            if (cooldownTimer) {
                clearInterval(cooldownTimer);
                cooldownTimer = null;
            }
            
            reprocessBtn.disabled = false;
            reprocessBtn.classList.remove('btn-disabled');
            reprocessTimer.classList.add('hidden');
        }
        
        function clearMultiCooldown() {
            if (multiCooldownTimer) {
                clearInterval(multiCooldownTimer);
                multiCooldownTimer = null;
            }
            
            multiReprocessBtn.disabled = false;
            multiReprocessBtn.classList.remove('btn-disabled');
            multiReprocessTimer.classList.add('hidden');
        }

        // 拖拽功能 - 单图
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('border-primary');
            uploadArea.classList.add('bg-yellow-50');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('border-primary');
            uploadArea.classList.remove('bg-yellow-50');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('border-primary');
            uploadArea.classList.remove('bg-yellow-50');
            
            if (e.dataTransfer.files.length) {
                imageUpload.files = e.dataTransfer.files;
                handleImageUpload();
                clearCooldown();
                currentWaitAttempt = 0;
            }
        });
        
        // 拖拽功能 - 多图1
        uploadArea1.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea1.classList.add('border-primary');
            uploadArea1.classList.add('bg-yellow-50');
        });

        uploadArea1.addEventListener('dragleave', () => {
            uploadArea1.classList.remove('border-primary');
            uploadArea1.classList.remove('bg-yellow-50');
        });

        uploadArea1.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea1.classList.remove('border-primary');
            uploadArea1.classList.remove('bg-yellow-50');
            
            if (e.dataTransfer.files.length) {
                imageUpload1.files = e.dataTransfer.files;
                handleImageUpload1();
                clearMultiCooldown();
                currentWaitAttempt = 0;
            }
        });
        
        // 拖拽功能 - 多图2
        uploadArea2.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea2.classList.add('border-primary');
            uploadArea2.classList.add('bg-yellow-50');
        });

        uploadArea2.addEventListener('dragleave', () => {
            uploadArea2.classList.remove('border-primary');
            uploadArea2.classList.remove('bg-yellow-50');
        });

        uploadArea2.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea2.classList.remove('border-primary');
            uploadArea2.classList.remove('bg-yellow-50');
            
            if (e.dataTransfer.files.length) {
                imageUpload2.files = e.dataTransfer.files;
                handleImageUpload2();
                clearMultiCooldown();
                currentWaitAttempt = 0;
            }
        });

        // 处理图片上传 - 单图
        imageUpload.addEventListener('change', handleImageUpload);

        function handleImageUpload() {
            const file = imageUpload.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                showError('请上传图片文件');
                return;
            }

            if (file.size > 10 * 1024 * 1024) {
                modals.imageTooLarge.classList.add('active');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreview.src = e.target.result;
                imagePreviewContainer.classList.remove('hidden');
                uploadArea.classList.add('hidden');
                
                resultImageContainer.classList.add('hidden');
                resultArea.classList.remove('hidden');
                errorContainer.classList.add('hidden');
                
                validateProcessButton();
            };
            reader.readAsDataURL(file);
        }
        
        // 处理图片上传 - 多图1
        imageUpload1.addEventListener('change', handleImageUpload1);

        function handleImageUpload1() {
            const file = imageUpload1.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                showError('请上传图片文件');
                return;
            }

            if (file.size > 10 * 1024 * 1024) {
                modals.imageTooLarge.classList.add('active');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreview1.src = e.target.result;
                imagePreviewContainer1.classList.remove('hidden');
                uploadArea1.classList.add('hidden');
                
                multiResultImageContainer.classList.add('hidden');
                multiResultArea.classList.remove('hidden');
                errorContainer.classList.add('hidden');
                
                validateProcessButton();
            };
            reader.readAsDataURL(file);
        }
        
        // 处理图片上传 - 多图2
        imageUpload2.addEventListener('change', handleImageUpload2);

        function handleImageUpload2() {
            const file = imageUpload2.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                showError('请上传图片文件');
                return;
            }

            if (file.size > 10 * 1024 * 1024) {
                modals.imageTooLarge.classList.add('active');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreview2.src = e.target.result;
                imagePreviewContainer2.classList.remove('hidden');
                uploadArea2.classList.add('hidden');
                
                multiResultImageContainer.classList.add('hidden');
                multiResultArea.classList.remove('hidden');
                errorContainer.classList.add('hidden');
                
                validateProcessButton();
            };
            reader.readAsDataURL(file);
        }

        // 更新处理次数显示
        function updateProcessCount() {
            processCountElement.textContent = processCount;
            multiProcessCountElement.textContent = processCount;
        }

        // 处理按钮点击事件
        processBtn.addEventListener('click', () => {
            if (!ACCESS_PASSWORD) {
                accessPasswordInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                accessPasswordInput.classList.add('border-red-300');
                setTimeout(() => {
                    accessPasswordInput.classList.remove('border-red-300');
                }, 1000);
                return;
            }
            
            if (selectedInstruction === 'vector' && !selectedRatio) {
                ratioRequired.classList.remove('hidden');
                document.getElementById('vector-options').scrollIntoView({ behavior: 'smooth', block: 'center' });
                return;
            }
            
            if (selectedInstruction === 'advanced' && (!customInstruction || customInstruction.length < 5)) {
                instructionRequired.classList.remove('hidden');
                customInstructionInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                setTimeout(() => {
                    customInstructionInput.focus();
                }, 300);
                return;
            }
            
            processImage();
            if (selectedInstruction === 'advanced') {
                startMultiCooldown();
            } else {
                startCooldown();
            }
        });

        // 模拟绘画进度更新
        function startPaintingProgressSimulation() {
            let paintingProgress = 0;
            paintingBar.style.width = '0%';
            paintingProgress.style.display = 'block';
            
            if (paintingTimer) {
                clearInterval(paintingTimer);
            }
            
            paintingTimer = setInterval(() => {
                paintingProgress += Math.random() * 5;
                if (paintingProgress > 90) paintingProgress = 90;
                paintingBar.style.width = `${paintingProgress}%`;
            }, PAINTING_PROGRESS_INTERVAL);
        }

        // 停止绘画进度模拟并完成
        function completePaintingProgress() {
            if (paintingTimer) {
                clearInterval(paintingTimer);
                paintingTimer = null;
            }
            paintingBar.style.width = '100%';
            setTimeout(() => {
                paintingProgress.style.display = 'none';
            }, 1000);
        }

        // 图片处理函数
        async function processImage() {
            if (!ACCESS_PASSWORD) {
                showError('请先输入密码');
                return;
            }
            
            if (selectedInstruction === 'vector' && !selectedRatio) {
                showError('请为通用/矢量风格图案选择输出比例');
                return;
            }
            
            if (selectedInstruction === 'advanced' && (!customInstruction || customInstruction.length < 5)) {
                showError('请输入有效的处理指令（至少5个字符）');
                return;
            }
            
            errorContainer.classList.add('hidden');
            
            statusContainer.classList.remove('hidden');
            statusMessage.textContent = '正在准备图片...';
            updateProgress(10);
            paintingProgress.style.display = 'none';
            
            processBtn.disabled = true;
            reprocessBtn.disabled = true;
            multiReprocessBtn.disabled = true;

            try {
                currentSessionId = generateSessionId();
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), API_TIMEOUT);

                // 准备图片数据 - 根据处理类型准备单张或多张图片
                let imageContents = [];
                if (selectedInstruction === 'advanced') {
                    // 进一步处理 - 准备已上传的图片（1张或2张）
                    const base64Image1 = await convertImageToBase64(imagePreview1.src);
                    imageContents.push({
                        "type": "image_url",
                        "image_url": {
                            "url": `data:image/jpeg;base64,${base64Image1}`
                        }
                    });
                    
                    // 如果第二张图片已上传，也添加进去
                    if (imagePreviewContainer2.classList.contains('hidden') === false) {
                        const base64Image2 = await convertImageToBase64(imagePreview2.src);
                        imageContents.push({
                            "type": "image_url",
                            "image_url": {
                                "url": `data:image/jpeg;base64,${base64Image2}`
                            }
                        });
                    }
                } else {
                    // 其他处理 - 准备一张图片
                    const base64Image = await convertImageToBase64(imagePreview.src);
                    imageContents.push({
                        "type": "image_url",
                        "image_url": {
                            "url": `data:image/jpeg;base64,${base64Image}`
                        }
                    });
                }
                
                updateProgress(30);
                statusMessage.textContent = '正在分析图片内容...';

                // 构建指令文本
                let instructionText = instructionDetails[selectedInstruction] || instructionDetails.repeat;
                
                if (selectedInstruction === 'vector') {
                    let styleTexts = [];
                    if (selectedStyle.includes('vector')) {
                        styleTexts.push('7. 输出风格矢量');
                    }
                    if (selectedStyle.includes('seamless')) {
                        styleTexts.push('7. 要求四方循环无缝衔接');
                    }
                    
                    if (styleTexts.length > 1) {
                        styleTexts = styleTexts.map((text, index) => {
                            return text.replace('7.', `${7 + index}.`);
                        });
                    }
                    
                    const styleText = styleTexts.join('\n');
                    const ratioText = `8. 输出比例${selectedRatio}`;
                    
                    instructionText = instructionText
                        .replace('{styleOptions}', styleText ? styleText : '')
                        .replace('{ratioOption}', ratioText);
                } else if (selectedInstruction === 'advanced') {
                    instructionText = instructionText.replace('{customInstruction}', customInstruction);
                }
                
                instructionText += `\n\n会话ID: ${currentSessionId}`;

                // 构建消息内容（包含所有图片）
                const contentList = [{"type": "text", "text": instructionText}];
                contentList.push(...imageContents);

                const messages = [
                    {
                        "role": "user",
                        "content": contentList
                    }
                ];

                // API调用 - 使用Gemini API格式
                const result = await Promise.race([
                    callPatternExtractionAPI(messages, controller.signal, currentSessionId),
                    new Promise((_, reject) => {
                        setTimeout(() => reject(new Error('请求超时，超过20分钟未收到响应')), API_TIMEOUT);
                    })
                ]);

                clearTimeout(timeoutId);
                
                if (!result || (!result.imageUrl && !result.base64Image)) {
                    if (result && result.isPainting) {
                        statusMessage.textContent = `AI正在绘制图案，将定期检查结果 (1/${MAX_WAIT_ATTEMPTS})`;
                        paintingProgress.style.display = 'block';
                        startPaintingProgressSimulation();
                        updateProgress(60);
                        
                        currentWaitAttempt = 1;
                        setTimeout(() => {
                            checkProcessingResult(currentSessionId);
                        }, CHECK_RESULT_INTERVAL);
                        return;
                    } else {
                        throw new Error('未能获取有效的处理结果');
                    }
                }
                
                updateProgress(80);
                statusMessage.textContent = '正在处理结果...';
                completePaintingProgress();

                // 增加处理次数
                processCount++;
                updateProcessCount();
                
                // 根据处理类型显示对应的结果区域
                if (selectedInstruction === 'advanced') {
                    multiResultImage.onload = () => {
                        multiResultArea.classList.add('hidden');
                        multiResultImageContainer.classList.remove('hidden');
                        updateProgress(100);
                        statusMessage.textContent = '处理完成';
                        
                        addToHistory(multiResultImage.src);
                        
                        setTimeout(() => {
                            statusContainer.classList.add('hidden');
                            updateProgress(0);
                            multiReprocessBtn.disabled = multiReprocessBtn.classList.contains('btn-disabled');
                            validateProcessButton();
                            currentWaitAttempt = 0;
                        }, 1500);
                    };
                    
                    multiResultImage.onerror = () => {
                        throw new Error('无法加载处理后的图片，可能是图片地址无效或已过期');
                    };
                    
                    multiResultImage.src = result.base64Image || result.imageUrl;
                } else {
                    resultImage.onload = () => {
                        resultArea.classList.add('hidden');
                        resultImageContainer.classList.remove('hidden');
                        updateProgress(100);
                        statusMessage.textContent = '处理完成';
                        
                        addToHistory(resultImage.src);
                        
                        setTimeout(() => {
                            statusContainer.classList.add('hidden');
                            updateProgress(0);
                            reprocessBtn.disabled = reprocessBtn.classList.contains('btn-disabled');
                            validateProcessButton();
                            currentWaitAttempt = 0;
                        }, 1500);
                    };
                    
                    resultImage.onerror = () => {
                        throw new Error('无法加载处理后的图片，可能是图片地址无效或已过期');
                    };
                    
                    resultImage.src = result.base64Image || result.imageUrl;
                }
                
            } catch (error) {
                console.error('处理图片时出错:', error);
                completePaintingProgress();
                
                statusContainer.classList.remove('hidden');
                statusMessage.textContent = '处理出错';
                updateProgress(0);
                
                if (error.message.includes('Unauthorized') && error.message.includes('401')) {
                    modals.usageExhausted.classList.add('active');
                    accessPasswordInput.value = '';
                    ACCESS_PASSWORD = '';
                    processBtn.disabled = true;
                    return;
                }
                
                if (error.message.includes('Service Unavailable') && 
                    error.message.includes('503') && 
                    error.message.includes('所有令牌分组 Gemini原价 下对于模型 gpt-image-1 均无可用渠道，请更换分组尝试')) {
                    modals.changeToken.classList.add('active');
                    accessPasswordInput.value = '';
                    ACCESS_PASSWORD = '';
                    processBtn.disabled = true;
                    return;
                }
                
                let errorMsg = error.message || '处理图片时发生错误，请重试';
                if (error.name === 'AbortError') {
                    errorMsg = '请求已超时，超过20分钟未收到响应，请重试';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMsg = '无法连接到服务器，请检查网络连接';
                } else if (error.message.includes('Unauthorized') || error.message.includes('Invalid Token')) {
                    errorMsg += '\n\n请检查密码是否正确有效';
                }
                
                if (error.message.includes('未找到有效的图片地址') && 
                    error.message.includes('🖌️正在绘画')) {
                    errorMsg += '\n\nAI可能仍在处理中，您可以选择"继续等待"或"重试"';
                }
                
                showError(errorMsg);
                resetProcessingState();
                clearCooldown();
                clearMultiCooldown();
            }
        }

        // 检查处理结果（用于轮询）
        async function checkProcessingResult(sessionId) {
            if (sessionId !== currentSessionId) {
                return;
            }
            
            try {
                statusMessage.textContent = `正在检查结果 (${currentWaitAttempt}/${MAX_WAIT_ATTEMPTS})`;
                
                // 构建检查结果的请求
                const payload = {
                    "model": selectedModel,
                    "messages": [
                        {
                            "role": "user",
                            "content": [
                                {
                                    "type": "text",
                                    "text": `请返回会话ID为${sessionId}的图片处理结果，仅返回图片URL或Base64编码，不添加任何其他文字。`
                                }
                            ]
                        }
                    ],
                    "max_tokens": 100
                };
                
                const response = await fetch(API_ENDPOINT, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${ACCESS_PASSWORD}`
                    },
                    body: JSON.stringify(payload)
                });
                
                if (response.status === 401) {
                    modals.usageExhausted.classList.add('active');
                    accessPasswordInput.value = '';
                    ACCESS_PASSWORD = '';
                    processBtn.disabled = true;
                    statusContainer.classList.add('hidden');
                    return;
                }
                
                if (response.status === 503) {
                    if (await response.text().includes('所有令牌分组 Gemini原价 下对于模型 gpt-image-1 均无可用渠道，请更换分组尝试')) {
                        modals.changeToken.classList.add('active');
                        accessPasswordInput.value = '';
                        ACCESS_PASSWORD = '';
                        processBtn.disabled = true;
                        statusContainer.classList.add('hidden');
                        return;
                    }
                }
                
                if (!response.ok) {
                    throw new Error(`检查结果失败: ${response.statusText}`);
                }
                
                let data;
                try {
                    data = await response.json();
                } catch (e) {
                    throw new Error(`解析响应失败: ${e.message}, 响应内容: ${await response.text()}`);
                }
                
                let fullResponse = '';
                
                if (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) {
                    fullResponse = data.choices[0].message.content;
                }
                
                const extractedData = extractImageData(fullResponse);
                const imageUrl = extractedData.imageUrl;
                const base64Image = extractedData.base64Image;

                const isPainting = fullResponse.includes('🖌️正在绘画') || 
                                  fullResponse.includes('仍在处理') ||
                                  fullResponse.includes('继续绘画');

                if (imageUrl || base64Image) {
                    completePaintingProgress();
                    updateProgress(80);
                    statusMessage.textContent = '正在处理结果...';
                    
                    processCount++;
                    updateProcessCount();
                    
                    if (selectedInstruction === 'advanced') {
                        multiResultImage.onload = () => {
                            multiResultArea.classList.add('hidden');
                            multiResultImageContainer.classList.remove('hidden');
                            updateProgress(100);
                            statusMessage.textContent = '处理完成';
                            
                            addToHistory(multiResultImage.src);
                            
                            setTimeout(() => {
                                statusContainer.classList.add('hidden');
                                updateProgress(0);
                                multiReprocessBtn.disabled = multiReprocessBtn.classList.contains('btn-disabled');
                                validateProcessButton();
                                currentWaitAttempt = 0;
                            }, 1500);
                        };
                        
                        multiResultImage.src = base64Image || imageUrl;
                    } else {
                        resultImage.onload = () => {
                            resultArea.classList.add('hidden');
                            resultImageContainer.classList.remove('hidden');
                            updateProgress(100);
                            statusMessage.textContent = '处理完成';
                            
                            addToHistory(resultImage.src);
                            
                            setTimeout(() => {
                                statusContainer.classList.add('hidden');
                                updateProgress(0);
                                reprocessBtn.disabled = reprocessBtn.classList.contains('btn-disabled');
                                validateProcessButton();
                                currentWaitAttempt = 0;
                            }, 1500);
                        };
                        
                        resultImage.src = base64Image || imageUrl;
                    }
                    
                    return;
                }
                
                if (isPainting && currentWaitAttempt < MAX_WAIT_ATTEMPTS) {
                    currentWaitAttempt++;
                    statusMessage.textContent = `AI仍在绘制图案，将继续等待 (${currentWaitAttempt}/${MAX_WAIT_ATTEMPTS})`;
                    updateProgress(60 + (currentWaitAttempt / MAX_WAIT_ATTEMPTS) * 20);
                    
                    setTimeout(() => {
                        checkProcessingResult(sessionId);
                    }, CHECK_RESULT_INTERVAL);
                } else {
                    throw new Error(`经过多次尝试仍未获取到有效图片地址。\n\n最后响应: ${fullResponse.substring(0, 200)}...`);
                }
                
            } catch (error) {
                console.error('检查处理结果时出错:', error);
                
                if (error.message.includes('Unauthorized') && error.message.includes('401')) {
                    modals.usageExhausted.classList.add('active');
                    accessPasswordInput.value = '';
                    ACCESS_PASSWORD = '';
                    processBtn.disabled = true;
                    statusContainer.classList.add('hidden');
                    return;
                }
                
                if (error.message.includes('Service Unavailable') && 
                    error.message.includes('503') && 
                    error.message.includes('所有令牌分组 Gemini原价 下对于模型 gpt-image-1 均无可用渠道，请更换分组尝试')) {
                    modals.changeToken.classList.add('active');
                    accessPasswordInput.value = '';
                    ACCESS_PASSWORD = '';
                    processBtn.disabled = true;
                    statusContainer.classList.add('hidden');
                    return;
                }
                
                showError(`检查结果时出错: ${error.message}\n\n您可以选择"继续等待"或"重试"`);
                resetProcessingState();
            }
        }

        // 生成会话ID
        function generateSessionId() {
            const sessionId = 'session_' + Date.now() + '_' + Math.floor(Math.random() * 10000);
            return sessionId;
        }

        // 转换图片为base64
        function convertImageToBase64(imageUrl) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                const imgTimeout = setTimeout(() => {
                    const errorMsg = '图片加载超时';
                    reject(new Error(errorMsg));
                }, 10000);
                img.onload = () => {
                    clearTimeout(imgTimeout);
                    const canvas = document.createElement('canvas');
                    const maxDim = 800;
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > height && width > maxDim) {
                        height = height * (maxDim / width);
                        width = maxDim;
                    } else if (height > maxDim) {
                        width = width * (maxDim / height);
                        height = maxDim;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    try {
                        const base64 = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];
                        resolve(base64);
                    } catch (error) {
                        const errorMsg = '无法处理图片，请尝试其他图片';
                        reject(new Error(errorMsg));
                    }
                };
                img.onerror = () => {
                    clearTimeout(imgTimeout);
                    const errorMsg = '图片加载失败，请重试';
                    reject(new Error(errorMsg));
                };
                img.src = imageUrl;
            });
        }

        // 调用图案提取API - 支持多图上传的Gemini API格式
        async function callPatternExtractionAPI(messages, signal, sessionId) {
            statusMessage.textContent = '正在分析图片内容...';

            // 构建请求参数 - 符合Gemini API格式
            const payload = {
                "model": selectedModel,
                "messages": messages,
                "stream": true  // 启用流式响应
            };

            try {
                const response = await fetch(API_ENDPOINT, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${ACCESS_PASSWORD}`
                    },
                    body: JSON.stringify(payload),
                    signal: signal
                });

                if (response.status === 401) {
                    throw new Error(`API请求失败: Unauthorized（状态码：401）`);
                }
                
                if (response.status === 503) {
                    const errorDetails = await response.text();
                    if (errorDetails.includes('所有令牌分组 Gemini原价 下对于模型 gpt-image-1 均无可用渠道，请更换分组尝试')) {
                        throw new Error(`API请求失败: Service Unavailable（状态码：503）\n${errorDetails}`);
                    }
                }

                if (!response.ok) {
                    let errorDetails = await response.text();
                    
                    try {
                        const errorJson = JSON.parse(errorDetails);
                        errorDetails = errorJson.error?.message || errorDetails;
                    } catch (e) {
                        // 非JSON格式的错误信息
                    }
                    
                    throw new Error(`API请求失败: ${response.statusText}（状态码：${response.status}）\n${errorDetails}`);
                }

                // 处理流式响应
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let content = '';
                let fullStreamContent = '';
                let receivedPaintingStatus = false;
                
                statusMessage.textContent = '正在接收结果...';
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value, { stream: true });
                    content += chunk;
                    fullStreamContent += chunk;
                    
                    if (!receivedPaintingStatus && chunk.includes('🖌️正在绘画')) {
                        receivedPaintingStatus = true;
                        statusMessage.textContent = 'AI正在生成图案...';
                        paintingProgress.style.display = 'block';
                        startPaintingProgressSimulation();
                    }
                    
                    updateProgress(30 + Math.min(40, Math.floor((content.length / 1000) * 40)));
                }
                
                const lines = content.split('\n').filter(line => line.trim() !== '');
                let fullResponse = '';
                
                for (const line of lines) {
                    const data = line.replace(/^data: /, '');
                    if (data === '[DONE]') break;
                    
                    try {
                        const json = JSON.parse(data);
                        if (json.choices && json.choices[0] && json.choices[0].delta && json.choices[0].delta.content) {
                            fullResponse += json.choices[0].delta.content;
                        }
                    } catch (e) {
                        console.warn('解析流式数据失败:', e);
                    }
                }
                
                // 提取图片URL或Base64
                const extractedData = extractImageData(fullResponse);
                const imageUrl = extractedData.imageUrl;
                const base64Image = extractedData.base64Image;

                // 检查是否仍在绘画中
                const isPainting = fullResponse.includes('🖌️正在绘画') || 
                                  fullResponse.includes('仍在处理') ||
                                  fullResponse.includes('继续绘画');

                if (!imageUrl && !base64Image && isPainting) {
                    return { isPainting: true };
                }

                if (!imageUrl && !base64Image) {
                    console.error("无法提取图片URL或Base64，原始响应内容:", fullResponse);
                    throw new Error(`API返回内容中未找到有效的图片地址: ${fullResponse.substring(0, 200)}...`);
                }

                return { imageUrl: imageUrl, base64Image: base64Image };
            } catch (error) {
                if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    throw new Error(`无法连接到API服务器: ${error.message}\n请检查API地址是否正确或网络连接是否正常`);
                }
                throw error;
            }
        }

        // 增强的图片数据提取函数
        function extractImageData(content) {
            // 1. 移除所有绘画状态信息
            let cleanedContent = content.replace(/^>.*?(🖌️|正在绘画).*?(?=\n|$)/gmi, '').trim();
            
            // 2. 移除所有可能的状态提示文本
            const statusPatterns = [
                /正在生成图片.../gi,
                /正在处理您的请求.../gi,
                /请稍候.../gi,
                /绘画中.../gi,
                /仍在处理.../gi,
                /继续绘画.../gi
            ];
            
            statusPatterns.forEach(pattern => {
                cleanedContent = cleanedContent.replace(pattern, '').trim();
            });
            
            // 3. 移除所有可能的代码块标记
            cleanedContent = cleanedContent
                .replace(/`/g, '')
                .replace(/^json\s*/i, '')
                .replace(/^```.*?```$/gs, '')
                .replace(/^<ImageHere>$/, '');
            
            // 4. 尝试提取Base64编码
            const base64Match = cleanedContent.match(/data:image\/(png|jpeg|jpg|gif|webp);base64,[a-zA-Z0-9+/=]+/i);
            if (base64Match && base64Match[0]) {
                return { imageUrl: null, base64Image: base64Match[0] };
            }
            
            // 5. 尝试从Markdown图片格式中提取URL
            const markdownImageMatch = cleanedContent.match(/!\[.*?\]\((https?:\/\/[^\)]+\.(jpg|jpeg|png|gif|webp))\)/i);
            if (markdownImageMatch && markdownImageMatch[1]) {
                return { imageUrl: markdownImageMatch[1], base64Image: null };
            }
            
            // 6. 尝试提取Markdown链接格式的图片URL
            const markdownLinkMatch = cleanedContent.match(/\[.*?\]\((https?:\/\/filesystem\.site\/[^)]+\.(jpg|jpeg|png|gif|webp)[^)]*)\)/i);
            if (markdownLinkMatch && markdownLinkMatch[1]) {
                return { imageUrl: markdownLinkMatch[1], base64Image: null };
            }
            
            // 7. 尝试直接提取URL
            const urlMatch = cleanedContent.match(/(https?:\/\/[^\s]+\.(jpg|jpeg|png|gif|webp))/i);
            if (urlMatch && urlMatch[0]) {
                return { imageUrl: urlMatch[0], base64Image: null };
            }
            
            // 8. 检查内容是否为有效的URL
            if (isValidUrl(cleanedContent) && cleanedContent.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
                return { imageUrl: cleanedContent, base64Image: null };
            }
            
            // 9. 检查内容是否为JSON
            try {
                const jsonData = JSON.parse(cleanedContent);
                const possibleFields = ['image', 'url', 'image_url', 'result', 'output'];
                for (const field of possibleFields) {
                    if (jsonData[field]) {
                        if (jsonData[field].startsWith('data:image/') && jsonData[field].includes('base64,')) {
                            return { imageUrl: null, base64Image: jsonData[field] };
                        }
                        if (isValidUrl(jsonData[field]) && jsonData[field].match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
                            return { imageUrl: jsonData[field], base64Image: null };
                        }
                    }
                }
                
                if (jsonData.images && Array.isArray(jsonData.images)) {
                    for (const imgData of jsonData.images) {
                        if (typeof imgData === 'string' && imgData.startsWith('data:image/') && imgData.includes('base64,')) {
                            return { imageUrl: null, base64Image: imgData };
                        }
                        if (typeof imgData === 'string' && isValidUrl(imgData) && imgData.match(/\.(jpg|jpeg|png|gif|webp)/i)) {
                            return { imageUrl: imgData, base64Image: null };
                        }
                    }
                }
                
                if (Array.isArray(jsonData)) {
                    for (const item of jsonData) {
                        if (typeof item === 'string') {
                            if (item.startsWith('data:image/') && item.includes('base64,')) {
                                return { imageUrl: null, base64Image: item };
                            }
                            if (isValidUrl(item) && item.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
                                return { imageUrl: item, base64Image: null };
                            }
                        }
                        if (typeof item === 'object' && item !== null) {
                            for (const key in item) {
                                if (typeof item[key] === 'string') {
                                    if (item[key].startsWith('data:image/') && item[key].includes('base64,')) {
                                        return { imageUrl: null, base64Image: item[key] };
                                    }
                                    if (isValidUrl(item[key]) && item[key].match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
                                        return { imageUrl: item[key], base64Image: null };
                                    }
                                }
                            }
                        }
                    }
                }
            } catch (e) {
                // 不是JSON格式
            }
            
            // 10. 作为最后的尝试，在原始内容中搜索
            const rawBase64Match = content.match(/data:image\/(png|jpeg|jpg|gif|webp);base64,[a-zA-Z0-9+/=]+/i);
            if (rawBase64Match && rawBase64Match[0]) {
                return { imageUrl: null, base64Image: rawBase64Match[0] };
            }
            
            const rawUrlMatch = content.match(/(https?:\/\/[^`\s]+\.(jpg|jpeg|png|gif|webp))/i);
            if (rawUrlMatch && rawUrlMatch[0]) {
                return { imageUrl: rawUrlMatch[0], base64Image: null };
            }
            
            return { imageUrl: null, base64Image: null };
        }

        // 验证URL有效性
        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        // 下载图片功能
        downloadBtn.addEventListener('click', async () => {
            await downloadImage(resultImage.src, "pattern_result");
        });
        
        multiDownloadBtn.addEventListener('click', async () => {
            await downloadImage(multiResultImage.src, "advanced_pattern_result");
        });
        
        async function downloadImage(imageSrc, prefix) {
            try {
                const originalText = this.innerHTML;
                this.innerHTML = '<i class="fa fa-spinner fa-spin mr-1"></i> 下载中...';
                this.disabled = true;

                let imageSrc = arguments[0];
                const timestamp = new Date().getTime();
                let extension = 'png';
                if (imageSrc.includes('data:image/jpeg') || imageSrc.includes('.jpg') || imageSrc.includes('.jpeg')) {
                    extension = 'jpg';
                } else if (imageSrc.includes('data:image/webp') || imageSrc.includes('.webp')) {
                    extension = 'webp';
                }
                const filename = `${arguments[1]}_${timestamp}.${extension}`;

                if (imageSrc.startsWith('data:')) {
                    const link = document.createElement('a');
                    link.href = imageSrc;
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else if (imageSrc.startsWith('http')) {
                    try {
                        let response = await fetch(imageSrc);
                        
                        if (!response.ok) {
                            response = await fetch(CORS_PROXY + imageSrc);
                        }
                        
                        if (!response.ok) {
                            throw new Error(`图片下载失败: ${response.statusText}`);
                        }
                        
                        const blob = await response.blob();
                        const url = URL.createObjectURL(blob);
                        
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = filename;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                    } catch (directError) {
                        try {
                            const img = new Image();
                            img.crossOrigin = "anonymous";
                            
                            await new Promise((resolve, reject) => {
                                img.onload = resolve;
                                img.onerror = reject;
                                img.src = imageSrc + (imageSrc.includes('?') ? '&' : '?') + 't=' + new Date().getTime();
                            });
                            
                            const canvas = document.createElement('canvas');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0);
                            
                            const dataUrl = canvas.toDataURL(`image/${extension}`);
                            
                            const link = document.createElement('a');
                            link.href = dataUrl;
                            link.download = filename;
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                        } catch (canvasError) {
                            throw new Error(`自动下载失败: ${directError.message}\n\n您可以右键点击图片选择"图片另存为"手动保存`);
                        }
                    }
                } else {
                    const link = document.createElement('a');
                    link.href = imageSrc;
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
                
                this.innerHTML = '<i class="fa fa-check mr-1"></i> 已下载';
                this.classList.add('bg-green-600');
                
                setTimeout(() => {
                    this.innerHTML = originalText;
                    this.classList.remove('bg-green-600');
                    this.disabled = false;
                }, 2000);
            } catch (err) {
                console.error('图片下载失败:', err);
                this.innerHTML = '<i class="fa fa-download mr-1"></i> 下载图片';
                this.disabled = false;
                
                showError(`下载图片失败: ${err.message}`);
            }
        }

        // 显示错误信息
        function showError(message) {
            errorMessage.innerHTML = message.replace(/\n/g, '<br>');
            errorContainer.classList.remove('hidden');
            statusContainer.classList.remove('hidden');
        }

        // 重置处理状态
        function resetProcessingState() {
            updateProgress(0);
            validateProcessButton();
            reprocessBtn.disabled = false;
            multiReprocessBtn.disabled = false;
        }

        // 添加到历史记录
        function addToHistory(imageUrl) {
            const placeholder = historyContainer.querySelector('.text-center.text-gray-500');
            if (placeholder) {
                historyContainer.removeChild(placeholder);
            }
            
            const historyItem = document.createElement('div');
            historyItem.className = 'relative overflow-hidden rounded-lg border border-gray-100 shadow-sm hover:shadow-md transition-custom';
            
            const img = document.createElement('img');
            img.src = imageUrl;
            img.alt = '历史处理结果';
            img.className = 'w-full h-24 object-cover cursor-zoom-in';
            img.title = '点击放大查看';
            
            img.addEventListener('click', () => {
                openImageZoom(imageUrl);
            });
            
            historyItem.appendChild(img);
            
            historyContainer.insertBefore(historyItem, historyContainer.firstChild);
            
            if (historyContainer.children.length > 8) {
                historyContainer.removeChild(historyContainer.lastChild);
            }
        }

        // 图片放大查看功能
        function openImageZoom(imageSrc) {
            zoomImage.src = imageSrc;
            imageZoom.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // 关闭图片放大查看
        function closeImageZoom() {
            imageZoom.classList.remove('active');
            document.body.style.overflow = '';
        }

        // 为图片添加点击放大事件
        imagePreview.addEventListener('click', () => {
            if (imagePreview.src) {
                openImageZoom(imagePreview.src);
            }
        });
        
        imagePreview1.addEventListener('click', () => {
            if (imagePreview1.src) {
                openImageZoom(imagePreview1.src);
            }
        });
        
        imagePreview2.addEventListener('click', () => {
            if (imagePreview2.src) {
                openImageZoom(imagePreview2.src);
            }
        });

        resultImage.addEventListener('click', () => {
            if (resultImage.src) {
                openImageZoom(resultImage.src);
            }
        });
        
        multiResultImage.addEventListener('click', () => {
            if (multiResultImage.src) {
                openImageZoom(multiResultImage.src);
            }
        });

        // 关闭按钮事件
        closeZoom.addEventListener('click', closeImageZoom);

        // 点击背景关闭放大查看
        imageZoom.addEventListener('click', (e) => {
            if (e.target === imageZoom) {
                closeImageZoom();
            }
        });

        // ESC键关闭放大查看
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && imageZoom.classList.contains('active')) {
                closeImageZoom();
            }
        });

        // 页面卸载时清除计时器
        window.addEventListener('beforeunload', () => {
            if (cooldownTimer) clearInterval(cooldownTimer);
            if (multiCooldownTimer) clearInterval(multiCooldownTimer);
            if (paintingTimer) clearInterval(paintingTimer);
        });

        // 更新进度
        function updateProgress(percent) {
            progressBar.style.width = `${percent}%`;
            progressText.textContent = `${percent}%`;
        }

        // 默认选择第一个指令
        if (instructionOptions.length > 0) {
            instructionOptions[0].click();
        }
    </script>
</body>
</html>
